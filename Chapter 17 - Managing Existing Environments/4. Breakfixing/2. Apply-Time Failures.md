# 2. Apply-Time Failures

While `terraform plan` provides us with excellent intelligence on what changes (or lack thereof) need to be made to our environments, sometimes things can go wrong in unexpected ways during the `terraform apply` even for the most well-intentioned plan. There are some things that you can do to try to stay ahead of these issues and lessen the frequency of encountering them. 

As we know, Terraform executes under an identity on whatever cloud platform we are targeting, and as a result, whatever permissions or privileges that identity has—so does Terraform. Being aware of what permissions Terraform’s identity has and what your code is doing well helps you identify if there are gaps that will result in authorization failures, as these are often implicit and hard to detect by Terraform. Some cloud platforms even require you to explicitly enable entire categories of cloud services before you use them. As we saw in chapters 13 through 15, Google Cloud is notorious for this and we were required to enable each of the relevant Google Cloud APIs within our Google Cloud Project before we could even attempt to provision something. On Azure, most common services are enabled by default, but some more obscure Resource Providers need to be explicitly enabled.

Beyond simply enabling the services you want to use, all cloud platforms implement default quotas that will restrict how much you can provision within certain contexts. These contexts are usually region or SKU-based. They provide joint protection for the cloud platform from a capacity planning standpoint but also for us as customers to prevent us from accidentally provisioning extremely expensive resources or too many of one kind of resource. Quotas are not the only limits imposed by the cloud platforms, there are often resource limits set for each service within a given deployment context such as within an AWS Account, an Azure Subscription or a Google Cloud Project.

In addition to quotas and service limits, often times when working with cloud services that employ private networking you may run into issues if network settings are misconfigured, such as incorrect Virtual Network and subnet configurations, or security group rules that prevent resources from being created or accessed. Sometimes, Terraform operates on a cloud service’s data plane, which might become unavailable when you configure it with private networking. Ensure that Terraform has the proper private networking in place to have a line of sight for necessary data planes.

Other Issues can arise with implicit resource dependencies that Terraform can’t determine through the configuration and plan. This can occur when a resource relies on another resource, but that relationship or dependency is not known to Terraform through direct references between the resources within the configuration. There could also be conflicts with existing resources, such as trying to create resources that already exist with the same name or other settings that can’t exist in more than one resource within the given scope—be it at a networking level or at the cloud platform’s control plane level.

Operations are taking longer than expected, and other transient platform errors lead to timeouts. Timeouts can result in the resources eventually being successfully provisioned, but because it happened after the operation timed out, Terraform won’t know about it. This can happen when large resources are being provisioned or when there are network delays.